name: Reusable Terraform EB Deploy

on:
  workflow_call:
    inputs:
      terraform_version:
        description: 'Terraform version to use'
        type: string
        default: '1.11.3'
      aws_region:
        description: 'AWS Region for deployment and S3 resources'
        type: string
        default: 'eu-west-1'
      working_directory:
        description: 'Root directory for Terraform configuration files'
        type: string
        default: 'src/main/webapp/resources/IaaC'
      eb_env_name:
        description: 'Elastic Beanstalk environment name (e.g., connect-env)'
        type: string
        default: ''
        required: false
      eb_app_name:
        description: 'Elastic Beanstalk application name'
        type: string
        default: ''
        required: false
      node_version:
        description: 'Node.js version for the application build'
        type: string
        default: '22.18.0'
      npm_version:
        description: 'NPM version to use'
        type: string
        default: '10.9.3'
      java_version:
        description: 'Java JDK version'
        type: string
        default: '21'
      maven_version:
        description: 'Apache Maven version'
        type: string
        default: '3.9.11'
      s3_bucket_name:
        description: 'S3 bucket name for uploading deployment artifacts'
        type: string
        required: false
      wm_profile:
        description: 'Application profile (e.g., prod, dev)'
        type: string
        default: 'prod'

    secrets:
      AWS_ROLE_TO_ASSUME_FOR_DEPLOY:
        description: 'IAM Role ARN for OIDC authentication'
        required: true

jobs:
  configure-elastic-beanstalk-enviroments:
      runs-on: ubuntu-latest
      permissions:
        id-token: write
        contents: read
      steps:
      - uses: actions/checkout@v4.2.2
  
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ inputs.terraform_version }}
  
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_FOR_DEPLOY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Extract S3 backend info from Terraform
        working-directory: ${{ inputs.working_directory }}
        id: s3info
        run: |
          set -e
      
          # 1️⃣ Controlla main.tf
          if [[ ! -f "main.tf" ]]; then
            echo "Errore: main.tf non trovato!"
            exit 1
          fi
      
          echo "main.tf trovato, inizializzo Terraform in modalità dry-run..."
          terraform init -backend=false -input=false
          terraform init -input=false -reconfigure
      
          TF_FILE=$(find . -name "*.tf" | head -n 1)
      
          # 2️⃣ Estrazione sicura
          BUCKET=$(grep -A10 'backend "s3"' "$TF_FILE" | grep -E 'bucket\s*=' || echo "" | head -n1 | awk -F'"' '{print $2}')
          KEY=$(grep -A10 'backend "s3"' "$TF_FILE" | grep -E 'key\s*=' || echo "" | head -n1 | awk -F'"' '{print $2}')
          REGION=$(grep -A10 'backend "s3"' "$TF_FILE" | grep -E 'region\s*=' || echo "" | head -n1 | awk -F'"' '{print $2}')
      
          # fallback se nulla trovato
          BUCKET=${BUCKET:-"unknown-bucket"}
          KEY=${KEY:-"unknown-key"}
          REGION=${REGION:-"unknown-region"}
          echo "------------------------Bucket------------------------------"      
          echo "Bucket=$BUCKET"
          echo "-------------------------Key-----------------------------"      
          echo "Key=$KEY"
          echo "----------------------------Region--------------------------"      
          echo "Region=$REGION"
          echo "------------------------------------------------------"      
      
          # 3️⃣ Output GitHub Actions
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "key=$KEY" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT


  wait-for-ready-enviroment:
    needs: configure-elastic-beanstalk-enviroments
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_FOR_DEPLOY }}
        aws-region: ${{ inputs.aws_region }}

    - name: Wait for Elastic Beanstalk environment to be ready
      run: |
          # Logica di fallback: se eb_env_name è vuoto, usa il nome del repo
          ENV_NAME="${{ inputs.eb_env_name }}"
          if [ -z "$ENV_NAME" ]; then
            ENV_NAME="${{ github.event.repository.name }}"
          fi
          echo "Using EB Environment Name: $ENV_NAME"
          ENV_NAME="$ENV_NAME-env"
          max_retries=30
          sleep_time=10
          
          echo "Checking Elastic Beanstalk environment $ENV_NAME ..."
          
          version_label=$(aws elasticbeanstalk describe-environments \
            --environment-names "$env_name" \
            --query "Environments[0].VersionLabel" \
            --output text)
          
          if [[ "$version_label" == "Sample Application" || "$version_label" == "None" ]]; then
            echo "Environment uses sample app. Skipping wait."
            exit 0
          fi
          
          for i in $(seq 1 $max_retries); do
            status=$(aws elasticbeanstalk describe-environments \
              --environment-names "$env_name" \
              --query "Environments[0].Status" \
              --output text)
            
            health=$(aws elasticbeanstalk describe-environments \
              --environment-names "$env_name" \
              --query "Environments[0].Health" \
              --output text)
            
            echo "Attempt $i: Status = $status, Health = $health"
            
            if [ "$status" = "Ready" ] && { [ "$health" = "Green" ] || [ "$health" = "Ok" ]; }; then
              echo "Environment is ready."
              exit 0
            fi
            sleep $sleep_time
          done
          exit 1

  # call-build-and-deploy:
  #   needs: wait-for-ready-enviroment
  #   permissions:
  #     id-token: write
  #     contents: read
  #   uses: OneClickApp-by-LOGCONSULTING/wm-elasticbeanstalk-publisher/.github/workflows/ebt-deployer.yml@main
  #   secrets: 
  #      AWS_ROLE_TO_ASSUME_FOR_DEPLOY: ${{ secrets.AWS_ROLE_TO_ASSUME_FOR_DEPLOY }}
  #   with:
  #     node-version: ${{ inputs.node_version }}
  #     npm-version: '10.9.3'
  #     maven-version: '3.9.11'
  #     java-version: ${{ inputs.java_version }}
  #     aws-region: ${{ inputs.aws_region }}
  #     environment-name: ${{ inputs.eb_env_name }}
  #     wm-app-name: ${{ inputs.eb_app_name }}
  #     beanstalk-application-name: ${{ inputs.eb_app_name }}
  #     wm-profile: 'prod'
  #     aws-s3-bucket-name: ${{ inputs.s3_bucket_name }}
  #     aws-s3-bucket-region: ${{ inputs.aws_region }}
  #     force-lowercase-wm-app-name: false
  #     log-group-prefix: ${{ inputs.eb_app_name }}
  #     force-root-wm-app-name: true
